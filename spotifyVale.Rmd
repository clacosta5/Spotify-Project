---
title: "spotifyVale"
author: "cla"
date: "5/8/2021"
css: stileProgetto.css
output:
  rmdformats::readthedown:
    highlight: kate
---
```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

```{r}
library(jsonlite)
library(lubridate)
library(gghighlight)
library(spotifyr)
library(tidyverse)
library(knitr)
library(ggplot2)
library(plotly)
#GUIDE
#https://towardsdatascience.com/explore-your-activity-on-spotify-with-r-and-spotifyr-how-to-analyze-and-visualize-your-stream-dee41cb63526


streamHistory <- fromJSON("StreamingHistory0Vale.json", flatten = TRUE)


# cambiare ora!!! perchè orario di greenwitch
#tz = a character string that specifies which time zone to parse the date with. The string must be a time zone that is #recognized by the user's OS.
a <- ymd_hm(streamHistory$endTime, tz = "Etc/GMT+0")
#cambio l'orario con quello del fuso di ROma
streamHistory2 <- streamHistory %>%
  mutate(endTime = with_tz(a, "Europe/Rome"))
```

On what dates did you listen to more or less music on Spotify?
This is the first question that you could answer. Starting from our variables, you can define the hours, minutes and seconds, and basically any temporality. You can make a first plot to observe the behavior of your activity on Spotify throughout the year, per week for example.
# PLAYBACK ACTIVITY PER WEEK AND HOURS
```{r}
# ADDING DATE AND TIMING
# prova con i secondi
mySpotify = streamHistory2 %>% 
  as_tibble() %>% #as_tibble() turns an existing object, such as a data frame or matrix, into a so-called tibble, a data                   #frame with class tbl_df
  mutate_at("endTime", ymd_hms) %>%  #aggiungo i secondi
  mutate(date = floor_date(endTime, "day") %>% as_date, seconds = msPlayed / 1000, minutes = seconds / 60)
# date -> prendo la data e basta senza orario, ricavo secondi e minuti suonati


oreStreaming = mySpotify %>% 
  filter(date >= "2020-01-01") %>% 
  group_by(date) %>% 
  group_by(date = floor_date(date, "week")) %>%  # raggruppo per settimane
  summarize(ore = sum(minutes) / 60) %>%         # sommo i minuti di ogni settimana / 60 = ore
  #verb summarise() riduce più valori fino a un singolo riassunto
  arrange(date) %>%                              # metto in ordine di data crescente
  ggplot(aes(x = date, y = ore)) + 
  geom_col(aes(fill = ore)) +
  scale_fill_gradient(low = "blue", high = "red") + 
  labs(x= "data", y= "ore di ascolto") + 
  ggtitle("In che date ho ascoltato più o meno musica su Spotify?", "Attività di ascolto per settimana da agosto 2020 a agosto 2021")

ggplotly(oreStreaming)
```


# PLAYBACK ACTIVITY PER SPECIFIC ARTIST
```{r}

oreArtista <- mySpotify %>% 
  group_by(artistName, date = floor_date(date, "month")) %>%  #raggruppo per ascolto mensile
  summarize(hours = sum(minutes) / 60) %>% 
  ggplot(aes(x = date, y = hours, group = artistName)) +
  geom_line(aes(color = artistName)) +
  geom_point(aes(color = artistName)) +
  labs(x= "date", y= "ore di ascolto") + 
  ggtitle("In che mese ho ascoltato più o meno musica di uno specifico artista?") +
  gghighlight(artistName == "Red Hot Chili Peppers" || artistName == "Guns N' Roses" || artistName == "Avril Lavigne" || artistName == "System Of A Down" || artistName == "blink-182" || artistName == "Rage Against The Machine" || artistName == "Muse" || artistName == "Wolfgang Amadeus Mozart" || artistName == "Nirvana") 

ggplotly(oreArtista)
```


# MOST LISTENED ARTISTS (MORE THAN 1 HOURS)
```{r}

minutesMostListened <- mySpotify %>% 
  filter(date >= "2020-01-01") %>% 
  group_by(artistName) %>% 
  summarize(minutesListened = sum(minutes)) %>% 
  filter(minutesListened >= 30) %>%
  ggplot(aes(x = artistName, y = minutesListened)) + 
  geom_col(aes(fill = minutesListened, text = (minutesListened/60))) +
  scale_fill_gradient(low = "blue", high = "red") + 
  labs(x= "Artist", y= "Minutes of music playback") + 
  ggtitle("What were the most listened artists on my Spotify? (> 10 ore di ascolto)") +
  theme(axis.text.x = element_text(angle = 90))
ggplotly(minutesMostListened)
```

# PLAYBACK ACTIVITY BY DATE AND TIME OF DAY
```{r}

timeDay <- mySpotify %>% 
  filter(date >= "2020-01-01") %>% 
  group_by(date, hour = hour(endTime)) %>% 
  summarize(minutesListened = sum(minutes)) %>% 
  ggplot(aes(x = hour, y = date, fill = minutesListened)) + 
  geom_tile() + 
  labs(x= "Time of the day", y= "Date") + 
  ggtitle("When has there been more playback activity on my Spotify?", "Activity by date and time of day") +
  scale_fill_gradient(low = "green", high = "blue")
timeDay
```


# PLAYBACK ACTIVITY BY TIME OF THE DAY
```{r}

hoursDay <- mySpotify %>% 
  filter(date >= "2020-01-01") %>% 
  group_by(date, hour = hour(endTime), weekday = wday(date, label = TRUE))%>% 
  summarize(minutesListened = sum(minutes))
  hoursDay %>% 
  ggplot(aes(x = hour, y = minutesListened, group = date)) +
  geom_col(fill = "#66b2ff") +
  labs(x= "Time of the day", y= "Minutes of music playback") + 
  ggtitle("What time of day I've listened to the most music on Spotify?", "Activity from 0 to 24 hours")
  

```




